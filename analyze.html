<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>分析</title>
  <link rel="stylesheet" href="assets/app.css" />
  <style>
    #cameraBox{
      width: 360px; height: 480px;
      border-radius: 22px;
      overflow:hidden;
      position:relative;
      background: rgba(0,0,0,.25);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(0,0,0,.08);
      box-shadow: 0 20px 70px rgba(0,0,0,.18);
    }
    video{width:100%; height:100%; object-fit:cover; filter: contrast(1.02) saturate(1.08);}

    .hint{
      position:absolute; top:14px; left:12px; right:12px;
      padding:10px 12px; border-radius:14px;
      background: rgba(0,0,0,.26);
      border:1px solid rgba(255,255,255,.22);
      color: rgba(255,255,255,.92);
      font-size:13px; letter-spacing:.6px; text-align:center;
      z-index: 4;
    }

    #faceGuide{
      position:absolute; inset: 74px 44px 98px 44px;
      border-radius: 999px;
      border:2px dashed rgba(255,255,255,.65);
      pointer-events:none;
      animation: pulse 2.5s infinite ease-in-out;
      z-index: 3;
    }
    @keyframes pulse{
      0%{opacity:.35;transform:scale(.985)}
      50%{opacity:.85;transform:scale(1)}
      100%{opacity:.35;transform:scale(.985)}
    }

    #captureBtn{
      position:absolute; left:50%; bottom:16px; transform:translateX(-50%);
      width:76px; height:76px; border-radius:999px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.75), rgba(255,255,255,0) 45%),
        linear-gradient(135deg, rgba(255,157,184,.95), rgba(242,216,140,.92));
      border:6px solid rgba(255,255,255,.92);
      box-shadow: 0 10px 24px rgba(255,157,184,.22), 0 26px 60px rgba(0,0,0,.25);
      cursor:pointer;
      z-index: 5;
    }

    #cameraBox.loading::after{
      content:"AI 分析中…";
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      background: rgba(10,14,24,.62);
      font-size:18px; letter-spacing:2px;
      z-index: 10;
    }

    #flash{
      position:fixed; inset:0;
      background:#fff; opacity:0;
      pointer-events:none;
      transition:opacity .15s;
    }

    @media (max-width: 920px){
      #cameraBox{ width:min(92vw,420px); height:min(128vw,560px); }
    }
  </style>
</head>

<body>
  <div class="bg-glass"></div>

  <header>
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>照相</h1>
        <p>拍照頁面</p>
      </div>
    </div>
    <button class="btn" onclick="location.href='index.html'">回首頁</button>
  </header>

  <div class="stage">
    <div id="cameraBox">
      <video id="video" autoplay playsinline></video>
      <div class="hint">請將臉部對準框線，光線充足更準確</div>
      <div id="faceGuide"></div>
      <div id="captureBtn" aria-label="拍照" role="button"></div>
    </div>
  </div>

  <div id="flash"></div>
  <div class="toast" id="toast"></div>
  <canvas id="canvas" style="display:none;"></canvas>

  <script>
    // ------- toast -------
    const toastEl = document.getElementById("toast");
    function toast(msg){
      if(!toastEl) return alert(msg);
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(()=> toastEl.classList.remove("show"), 2200);
    }

    // ------- 問卷資料（若沒有就給空物件） -------
    const surveyRaw = localStorage.getItem("survey") || "{}";

    // ------- DOM -------
    const video = document.getElementById("video");
    const cameraBox = document.getElementById("cameraBox");
    const captureBtn = document.getElementById("captureBtn");
    const canvas = document.getElementById("canvas");
    const flash = document.getElementById("flash");

    let stream = null;
    let busy = false;

    async function openCamera(){
      if(!navigator.mediaDevices?.getUserMedia){
        toast("此瀏覽器不支援相機");
        return;
      }

      try{
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode:"user", width:{ideal:1280}, height:{ideal:720} },
          audio:false
        });
      }catch(err){
        // fallback
        stream = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
      }

      video.srcObject = stream;

      await new Promise((resolve) => {
        if(video.readyState >= 2) return resolve();
        video.onloadedmetadata = () => resolve();
      });

      try{ await video.play(); }catch(e){}
    }

    function stopCamera(){
      if(!stream) return;
      stream.getTracks().forEach(t=>t.stop());
      stream = null;
    }

    function flashOnce(){
      flash.style.opacity = 1;
      setTimeout(()=> flash.style.opacity = 0, 120);
    }

    async function getJpegBlob(){
      const w = video.videoWidth;
      const h = video.videoHeight;
      if(!w || !h) throw new Error("Video not ready");

      canvas.width = w;
      canvas.height = h;

      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0, w, h);

      const blob = await new Promise((resolve) => {
        canvas.toBlob((b)=> resolve(b), "image/jpeg", 0.95);
      });

      if(!blob) throw new Error("toBlob failed");
      return blob;
    }

    captureBtn.addEventListener("click", async () => {
      if(busy) return;
      busy = true;
      cameraBox.classList.add("loading");

      try{
        if(!stream){
          toast("相機尚未開啟");
          return;
        }

        const blob = await getJpegBlob();
        flashOnce();

        const form = new FormData();
        form.append("photo", blob, "capture.jpg");
        form.append("survey", surveyRaw);

        const res = await fetch("./api/analyze.php", { method:"POST", body: form });

        if(!res.ok){
          toast("後端分析失敗(請看 api/analyze.php)");
          return;
        }

        const ct = res.headers.get("content-type") || "";
        if(!ct.includes("application/json")){
          const text = await res.text();
          console.error("Non-JSON response:", text.slice(0,400));
          toast("後端回傳不是 JSON（請檢查 PHP 輸出）");
          return;
        }

        const payload = await res.json();

        // ✅ 讓 result.html 吃得到
        localStorage.setItem("result", JSON.stringify(payload));

        stopCamera();
        location.href = "result.html";
      }catch(e){
        console.error(e);
        toast(e.message === "Video not ready" ? "相機尚未就緒，等一下再拍" : "拍照/上傳發生錯誤");
      }finally{
        cameraBox.classList.remove("loading");
        busy = false;
      }
    });

    openCamera().catch(e=>{
      console.error(e);
      toast("無法開啟相機：請允許權限，並用 http://localhost 方式開啟");
    });

    window.addEventListener("beforeunload", stopCamera);
  </script>
</body>
</html>
